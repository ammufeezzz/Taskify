generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Team {
  id                String             @id @default(cuid())
  name              String
  key               String             @unique
  groqApiKey        String?
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  chatConversations ChatConversation[]
  invitations       Invitation[]
  issues            Issue[]
  labels            Label[]
  projects          Project[]
  members           TeamMember[]
  workflowStates    WorkflowState[]

  @@map("teams")
}

model Project {
  id          String          @id @default(cuid())
  name        String
  description String?
  key         String
  color       String          @default("#6366f1")
  icon        String?
  status      String          @default("active")
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
  teamId      String
  leadId      String?
  lead        String?
  issues      Issue[]
  members     ProjectMember[]
  team        Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, key])
  @@map("projects")
}

model WorkflowState {
  id        String   @id @default(cuid())
  name      String
  type      String
  color     String   @default("#64748b")
  position  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teamId    String
  issues    Issue[]
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@map("workflow_states")
}

model Label {
  id        String       @id @default(cuid())
  name      String
  color     String       @default("#64748b")
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt
  teamId    String
  issues    IssueLabel[]
  team      Team         @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@map("labels")
}

model Issue {
  id              String          @id @default(cuid())
  title           String
  description     String?
  number          Int
  priority        String          @default("none")
  estimate        Int?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  completedAt     DateTime?
  teamId          String
  projectId       String?
  workflowStateId String
  assigneeId      String?
  assignee        String?
  creatorId       String
  creator         String
  difficulty      String?
  dueDate         DateTime?
  reviewedAt      DateTime?
  reviewerId      String? // User ID of the reviewer (Founder/Owner/Admin)
  reviewer        String? // Reviewer display name
  comments        Comment[]
  assignees       IssueAssignee[]
  labels          IssueLabel[]
  project         Project?        @relation(fields: [projectId], references: [id])
  team            Team            @relation(fields: [teamId], references: [id], onDelete: Cascade)
  workflowState   WorkflowState   @relation(fields: [workflowStateId], references: [id])

  @@unique([teamId, number])
  @@map("issues")
}

model IssueAssignee {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  issueId   String
  userId    String
  userName  String
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@unique([issueId, userId])
  @@map("issue_assignees")
}

model IssueLabel {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  issueId   String
  labelId   String
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)
  label     Label    @relation(fields: [labelId], references: [id], onDelete: Cascade)

  @@unique([issueId, labelId])
  @@map("issue_labels")
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  issueId   String
  userId    String
  user      String
  issue     Issue    @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model TeamMember {
  id        String   @id @default(cuid())
  role      String   @default("developer")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  teamId    String
  userId    String
  userEmail String
  userName  String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@map("team_members")
}

model ProjectMember {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  projectId String
  userId    String
  userEmail String
  userName  String
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, userId])
  @@map("project_members")
}

model Invitation {
  id        String   @id @default(cuid())
  email     String
  role      String   @default("developer")
  status    String   @default("pending")
  invitedBy String
  createdAt DateTime @default(now())
  expiresAt DateTime
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, email])
  @@map("invitations")
}

model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean   @default(false)
  image         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @default(now()) @updatedAt
  accounts      Account[]
  sessions      Session[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("account")
}

model Verification {
  id         String   @id
  identifier String
  value      String
  expiresAt  DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @default(now()) @updatedAt

  @@map("verification")
}

model ChatConversation {
  id        String        @id @default(cuid())
  teamId    String
  userId    String
  title     String?
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
  team      Team          @relation(fields: [teamId], references: [id], onDelete: Cascade)
  messages  ChatMessage[]

  @@map("chat_conversations")
}

model ChatMessage {
  id             String           @id @default(cuid())
  conversationId String
  role           String
  content        String
  toolCalls      Json?
  createdAt      DateTime         @default(now())
  conversation   ChatConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@map("chat_messages")
}
